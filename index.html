<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
   
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f172a">
  <title>FastTrack</title>

  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3240/3240652.png">
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3240/3240652.png">
   
  <style>
    body { padding-top: env(safe-area-inset-top); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; user-select: none; }
    .progress-ring__circle { transition: stroke-dashoffset 0.5s ease-in-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* Phase Card Styles */
    .phase-card { @apply p-4 rounded-xl border border-slate-700 transition-all duration-300; }
    .phase-active { @apply border-orange-500 bg-slate-800 shadow-[0_0_15px_rgba(249,115,22,0.3)]; }
    .phase-done { @apply border-green-500 opacity-60; }
    .phase-locked { @apply opacity-30 grayscale; }
    
    /* Modal Animation */
    #modal { transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1); transform: translateY(100%); }
    #modal.open { transform: translateY(0); }
    
    /* Description Formatting */
    .phase-detail ul { list-style-type: disc; padding-left: 1.2rem; margin-top: 0.5rem; color: #94a3b8; font-size: 0.9rem; }
    .phase-detail strong { color: #f97316; }
    .phase-detail p { margin-bottom: 0.5rem; }
  </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center pb-64 no-scrollbar">

  <div class="w-full max-w-md flex justify-between items-center p-6 z-20">
    <div>
      <h1 class="text-xl font-bold text-slate-300 leading-none">FastTrack <span class="text-xs text-orange-500 align-top">Complete</span></h1>
      <p id="user-display" onclick="showLogoutModal()" class="text-xs text-slate-500 font-mono mt-1 cursor-pointer hover:text-red-400 transition-colors">
        Authenticating...
      </p>
    </div>
    <div class="flex gap-2 items-center">
        <button onclick="handleLogWeight()" class="bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white px-3 py-1 rounded-lg text-xs font-bold border border-slate-700 transition-colors">
          + Weight
        </button>
        <div id="streak-badge" class="bg-slate-800 px-3 py-1 rounded-full text-xs font-mono text-slate-500 border border-slate-700 min-w-[60px] text-center">...</div>
    </div>
  </div>

  <div class="relative w-72 h-72 flex items-center justify-center mb-8 shrink-0">
    <svg class="w-full h-full absolute" viewBox="0 0 120 120">
      <circle cx="60" cy="60" r="54" fill="none" stroke="#1e293b" stroke-width="8" />
      <circle id="progress-ring" class="progress-ring__circle" cx="60" cy="60" r="54" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round" stroke-dasharray="339.292" stroke-dashoffset="339.292" />
    </svg>
    <div class="z-10 text-center flex flex-col items-center">
      <div id="timer-display" onclick="handleAdjustStart()" class="text-5xl font-mono font-light tracking-tighter cursor-pointer hover:text-orange-400 transition-colors select-none" title="Tap to edit start time">00:00:00</div>
      
      <p id="timer-label" class="text-slate-400 text-sm mt-2 font-medium">Loading...</p>
      <div id="goal-selector" class="mt-4 hidden">
        <select id="goal-input" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5 focus:ring-orange-500 focus:border-orange-500">
          <option value="16" selected>16h (16:8)</option>
          <option value="18">18h (Warrior)</option>
          <option value="20">20h (Warrior+)</option>
          <option value="24">24h (OMAD)</option>
          <option value="36">36h (Monk)</option>
        </select>
      </div>
    </div>
  </div>

  <div id="history-container" class="w-full max-w-md px-6 mb-8 hidden">
    <div class="flex justify-between items-end mb-3">
      <h3 class="text-slate-500 text-xs font-bold uppercase tracking-widest">Recent Performance</h3>
      <span id="avg-badge" class="text-xs font-mono text-orange-400 bg-slate-800 px-2 py-1 rounded border border-slate-700">0h Avg</span>
    </div>
    <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 shadow-lg">
      <canvas id="fastChart" height="200"></canvas>
    </div>
  </div>

  <div class="w-full max-w-md px-6 space-y-3 pb-8">
    <h3 class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-1">Metabolic Roadmap</h3>
    <div id="phase-list" class="space-y-3"></div>
  </div>

  <button id="main-btn" onclick="handleToggle()" class="fixed bottom-24 left-1/2 -translate-x-1/2 w-[90%] max-w-md py-4 bg-orange-500 hover:bg-orange-600 active:scale-95 rounded-2xl text-xl font-bold shadow-2xl z-20 transition-all">
    Wait...
  </button>
   
  <div id="adjust-container" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-20 text-xs text-slate-500 underline cursor-pointer hover:text-orange-400 transition-colors hidden" onclick="handleAdjustStart()">
    Started earlier?
  </div>

  <div id="modal-overlay" onclick="closeModal()" class="fixed inset-0 bg-black/80 hidden z-30 backdrop-blur-sm transition-opacity"></div>
  <div id="modal" class="fixed bottom-0 left-0 right-0 bg-slate-800 rounded-t-[2.5rem] p-8 z-40 border-t border-slate-700 max-h-[85vh] overflow-y-auto">
    <div class="w-12 h-1.5 bg-slate-600 rounded-full mx-auto mb-6"></div>
    <h2 id="modal-title" class="text-2xl font-bold text-orange-400"></h2>
    <div id="modal-content" class="text-slate-300 leading-relaxed space-y-4 text-lg mt-4 phase-detail"></div>
    <button onclick="closeModal()" class="mt-8 w-full py-4 bg-slate-700 rounded-xl font-bold">Close</button>
  </div>

  <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 hidden">
    <div class="w-[85%] max-w-sm p-8 text-center">
      <div class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl text-3xl">üöÄ</div>
      <h2 class="text-2xl font-bold text-white mb-2">Welcome Back</h2>
      <p class="text-slate-400 text-sm mb-8">Enter credentials to sync your data.</p>
       
      <input id="login-user" type="text" placeholder="Username / Email" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white mb-3 focus:border-orange-500 outline-none" />
      <input id="login-pass" type="password" placeholder="Password" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white mb-6 focus:border-orange-500 outline-none" />
       
      <button onclick="performLogin()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 active:scale-95 rounded-xl text-lg font-bold shadow-lg transition-all">
        Login / Register
      </button>
      <p class="text-xs text-slate-600 mt-6">First time? Just enter a new user/pass.</p>
    </div>
  </div>

  <div id="logout-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
    <div class="bg-slate-800 border border-slate-700 w-[85%] max-w-sm p-6 rounded-2xl shadow-2xl transform scale-95 transition-transform duration-300" id="logout-box">
      <div class="w-12 h-12 bg-red-500/10 rounded-full flex items-center justify-center mb-4 text-2xl">üëã</div>
      <h3 class="text-xl font-bold text-white mb-2">Sign Out?</h3>
      <p class="text-slate-400 text-sm mb-6">This will clear local data and require a re-sync next time you login.</p>
      <div class="flex gap-3">
        <button onclick="hideLogoutModal()" class="flex-1 py-3 bg-slate-700 text-slate-300 rounded-xl font-bold">Cancel</button>
        <button onclick="confirmLogout()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold shadow-lg">Logout</button>
      </div>
    </div>
  </div>

  <div id="input-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
    <div class="bg-slate-800 border border-slate-700 w-[85%] max-w-sm p-6 rounded-2xl shadow-2xl transform scale-95 transition-transform duration-300" id="input-box">
      <h3 id="input-title" class="text-xl font-bold text-white mb-2">Input</h3>
      <p id="input-desc" class="text-slate-400 text-sm mb-4">Enter value below:</p>
      <input id="input-field" type="number" step="0.1" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-white text-lg mb-6 focus:ring-2 focus:ring-orange-500 outline-none" />
      <div class="flex gap-3">
        <button id="input-cancel-btn" class="flex-1 py-3 bg-slate-700 text-slate-300 rounded-xl font-bold">Cancel</button>
        <button id="input-confirm-btn" class="flex-1 py-3 bg-orange-500 text-white rounded-xl font-bold shadow-lg">Save</button>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    // Ensure this URL matches your deployed Google Apps Script Web App URL
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbxxOxHC_YaLg7e-vN1WOco3eN9nsRi867l7jwONV0G5gEqme_URKbpnkjM7D95UgMUDUg/exec"; 
    const DB_KEY = "fastTrackData_v2";
    const AUTH_KEY = "fastTrackAuth_v1";

    let auth = { user: null, pass: null };

    // --- AUTH SYSTEM ---
    function checkLogin() {
      const stored = localStorage.getItem(AUTH_KEY);
      if (stored) {
        auth = JSON.parse(stored);
        document.getElementById('user-display').innerText = auth.user;
        document.getElementById('user-display').classList.add("text-orange-400");
        initData();
      } else {
        document.getElementById('login-modal').classList.remove('hidden');
      }
    }

    function performLogin() {
      const user = document.getElementById('login-user').value.trim();
      const pass = document.getElementById('login-pass').value.trim();
       
      if (!user || !pass) return alert("Please fill both fields");
       
      // ... inside performLogin() ...
if (!user || !pass) return alert("Please fill both fields");

// HASH THE PASSWORD BEFORE SAVING
const hashedPass = await hashPassword(pass);
auth = { user: user, pass: hashedPass };

localStorage.setItem(AUTH_KEY, JSON.stringify(auth));

      localStorage.setItem(AUTH_KEY, JSON.stringify(auth));
       
      document.getElementById('login-modal').classList.add('hidden');
      document.getElementById('user-display').innerText = auth.user;
      document.getElementById('user-display').classList.add("text-orange-400");
       
      initData(true); 
    }

    function showLogoutModal() {
      const modal = document.getElementById('logout-modal');
      const box = document.getElementById('logout-box');
      modal.classList.remove('hidden');
      setTimeout(() => { modal.classList.remove('opacity-0'); box.classList.remove('scale-95'); box.classList.add('scale-100'); }, 10);
    }

    function hideLogoutModal() {
      const modal = document.getElementById('logout-modal');
      const box = document.getElementById('logout-box');
      modal.classList.add('opacity-0'); box.classList.remove('scale-100'); box.classList.add('scale-95');
      setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function confirmLogout() {
      localStorage.removeItem(AUTH_KEY);
      localStorage.removeItem(DB_KEY);
      location.reload();
    }

    // --- DATABASE UTILS ---
    function getDB() {
      const data = localStorage.getItem(DB_KEY);
      return data ? JSON.parse(data) : [];
    }

    function saveDB(data) {
      localStorage.setItem(DB_KEY, JSON.stringify(data));
    }

    // --- HYBRID API MANAGER (LOCAL + CLOUD) ---
    async function localApi(action, payload) {
      let db = getDB();
      const params = new URLSearchParams();
      params.append("userId", auth.user);
      params.append("password", auth.pass);
      params.append("action", action);
      
      // LOG WEIGHT INDEPENDENTLY
      if (action === "logWeight") {
        if (db.length > 0) {
            db[db.length - 1].weight = payload.weight;
            saveDB(db);
        }
        if (CLOUD_URL) {
            params.append("weight", payload.weight);
            await fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', body: params });
        }
        return { status: "logged" };
      }

      // INITIAL DATA SYNC
      if (action === "getInitialData") {
        if ((db.length === 0 || payload.force) && CLOUD_URL && auth.user) {
           console.log("Syncing with cloud...");
           try {
             const url = `${CLOUD_URL}?action=getInitialData&userId=${encodeURIComponent(auth.user)}&password=${encodeURIComponent(auth.pass)}`;
             const cloudRes = await fetch(url);
             const cloudData = await cloudRes.json();
             
             let newDB = [];
             // Import history
             if (cloudData.history) {
               cloudData.history.forEach(h => {
                 newDB.push({
                   id: Number(h.startTime),
                   startTime: Number(h.startTime),
                   endTime: Number(h.endTime),
                   status: "COMPLETED",
                   goal: Number(h.goal),
                   weight: h.weight
                 });
               });
             }
             // Import current fast
             if (cloudData.currentFast) {
               newDB.push({
                 id: Number(cloudData.currentFast.startTime),
                 startTime: Number(cloudData.currentFast.startTime),
                 goal: Number(cloudData.currentFast.goal),
                 status: "ACTIVE"
               });
             }
             saveDB(newDB);
             db = newDB; 
           } catch (e) {
             console.log("Cloud sync failed, using local data", e);
           }
        }
        const current = db.find(f => f.status === "ACTIVE");
        const history = db
          .filter(f => f.status === "COMPLETED")
          .sort((a, b) => b.endTime - a.endTime) 
          .map(f => {
            const sTime = Number(f.startTime);
            const eTime = Number(f.endTime);
            const hours = ((eTime - sTime) / 3600000).toFixed(2);
            return { 
              date: new Date(eTime).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }), 
              duration: hours, 
              goal: f.goal, 
              weight: f.weight 
            };
          });

        return {
          currentFast: current ? { startTime: current.startTime, goal: current.goal } : null,
          history: history
        };
      }

      // TOGGLE FAST (START / END)
      if (action === "toggleFast") {
        const activeIndex = db.findIndex(f => f.status === "ACTIVE");

        if (activeIndex === -1) {
          // --- STARTING ---
          const startTime = payload.customStartTime || Date.now();
          const newFast = { id: Date.now(), startTime: startTime, goal: payload.goalHours || 16, status: "ACTIVE" };
          db.push(newFast);
          saveDB(db);
          
          if (CLOUD_URL) {
            params.append("mode", "START");
            params.append("goalHours", payload.goalHours);
            if (payload.customStartTime) params.append("customStartTime", startTime);
            await fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', body: params });
          }
          return { status: "Started", startTime: startTime, goal: payload.goalHours || 16 };
        } else {
          // --- ENDING ---
          const endTime = payload.customEndTime || Date.now();
          db[activeIndex].status = "COMPLETED";
          db[activeIndex].endTime = endTime;
          if (payload.weight) db[activeIndex].weight = payload.weight;
          saveDB(db);
          
          if (CLOUD_URL) {
            params.append("mode", "END");
            if (payload.customEndTime) params.append("customEndTime", endTime);
            if (payload.weight) params.append("weight", payload.weight);
            await fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', body: params });
          }
          return { status: "Ended" };
        }
      }

      // ADJUST ACTIVE START TIME
      if (action === "adjustStart") {
        const activeIndex = db.findIndex(f => f.status === "ACTIVE");
        if (activeIndex !== -1 && payload.customStartTime) {
            db[activeIndex].startTime = payload.customStartTime;
            saveDB(db);
            if (CLOUD_URL) {
                params.append("mode", "ADJUST_START");
                params.append("customStartTime", payload.customStartTime);
                params.append("action", "toggleFast");
                await fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', body: params });
            }
            return { status: "Started", startTime: payload.customStartTime, goal: db[activeIndex].goal };
        }
      }
    }

    // --- APP STATE ---
    let startTime = null;
    let goalHours = 16;
    let timerInterval = null;
    let myChart = null;
    const circumference = 54 * 2 * Math.PI;

    // --- VERBOSE PHASES DATA ---
    const phases = [
      { 
        h: 0, 
        title: "Anabolic", 
        icon: "üçî", 
        detail: `
          <p><strong>Digestion Mode</strong></p>
          <p>Your body is processing your last meal. Insulin levels rise to shuttle glucose into cells for energy or storage.</p>
          <ul>
            <li>Blood sugar rises</li>
            <li>Insulin spikes</li>
            <li>Glycogen stores refill</li>
          </ul>`
      },
      { 
        h: 4, 
        title: "Catabolic", 
        icon: "üìâ", 
        detail: `
          <p><strong>Blood Sugar Falls</strong></p>
          <p>Food has been digested. Insulin starts to drop, signaling your body to start using stored energy (glycogen) from the liver.</p>
          <ul>
            <li>Digestive system rests</li>
            <li>Ghrelin (hunger) may spike</li>
            <li>Healing mode begins</li>
          </ul>`
      },
      { 
        h: 12, 
        title: "Fat Burn", 
        icon: "üî•", 
        detail: `
          <p><strong>Metabolic Switch</strong></p>
          <p>Liver glycogen is running low. Your body transitions to burning stored body fat for fuel. You are entering mild ketosis.</p>
          <ul>
            <li>HGH (Human Growth Hormone) begins to rise</li>
            <li>Fat cells release energy</li>
            <li>Mental clarity improves</li>
          </ul>`
      },
      { 
        h: 18, 
        title: "Ketosis", 
        icon: "üß†", 
        detail: `
          <p><strong>Full Fat Burning</strong></p>
          <p>You are now running primarily on Ketones. This is a high-performance state for the brain and body.</p>
          <ul>
            <li>Deep fat burning mode</li>
            <li>Reduced inflammation</li>
            <li>Brain-Derived Neurotrophic Factor (BDNF) rises</li>
          </ul>`
      },
      { 
        h: 24, 
        title: "Autophagy", 
        icon: "‚ôªÔ∏è", 
        detail: `
          <p><strong>Cellular Cleanup</strong></p>
          <p>Your cells begin to recycle old, damaged components (organelles and proteins). This is deep anti-aging on a cellular level.</p>
          <ul>
            <li>"Self-eating" of junk cells</li>
            <li>Immune system reset begins</li>
            <li>Gut lining repair</li>
          </ul>`
      },
      { 
        h: 48, 
        title: "HGH Surge", 
        icon: "üí™", 
        detail: `
          <p><strong>Peak Repair</strong></p>
          <p>Human Growth Hormone levels skyrocket (up to 5x) to preserve muscle mass and accelerate healing.</p>
          <ul>
            <li>Massive HGH increase</li>
            <li>Metabolic rate actually increases</li>
            <li>Deepest level of cellular repair</li>
          </ul>`
      }
    ];

    function setProgress(percent) {
      const offset = circumference - (percent / 100) * circumference;
      document.getElementById('progress-ring').style.strokeDashoffset = offset;
    }

    function renderPhases(currentHours) {
      const container = document.getElementById('phase-list');
      container.innerHTML = '';
      
      

      phases.forEach((phase, index) => {
        const nextPhase = phases[index + 1];
        const isCurrent = currentHours >= phase.h && (!nextPhase || currentHours < nextPhase.h);
        const isDone = currentHours >= phase.h;
        
        let statusClass = "phase-locked";
        if (isCurrent) statusClass = "phase-active";
        else if (isDone) statusClass = "phase-done";
        
        const div = document.createElement('div');
        div.className = `phase-card flex items-center justify-between cursor-pointer ${statusClass}`;
        div.onclick = () => openModal(index);
        
        div.innerHTML = `
          <div class="flex items-center gap-4">
            <span class="text-2xl">${phase.icon}</span>
            <div>
              <div class="font-bold text-sm ${isCurrent ? 'text-orange-400' : 'text-slate-300'}">${phase.title}</div>
              <div class="text-xs text-slate-500 font-mono">${phase.h} Hours</div>
            </div>
          </div>
          ${isCurrent ? '<div class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></div>' : ''}
          ${isDone && !isCurrent ? '<div class="text-green-500 text-lg">‚úì</div>' : ''}
        `;
        container.appendChild(div);
      });
    }

    // --- UI MANAGER ---
    function updateUI() {
      const btn = document.getElementById('main-btn');
      const selector = document.getElementById('goal-selector');
      const label = document.getElementById('timer-label');
      const adjustLink = document.getElementById('adjust-container');
       
      if (!startTime) {
        document.getElementById('timer-display').innerText = "00:00:00";
        label.innerText = "Target Goal:";
        label.classList.remove("text-orange-400");
        btn.innerText = "Start Fasting";
        btn.className = "fixed bottom-24 left-1/2 -translate-x-1/2 w-[90%] max-w-md py-4 bg-orange-500 hover:bg-orange-600 active:scale-95 rounded-2xl text-xl font-bold shadow-2xl z-20 transition-all";
        adjustLink.classList.remove('hidden');
        selector.style.display = 'block';
        setProgress(0);
        renderPhases(-1);
        return;
      }

      selector.style.display = 'none';
      adjustLink.classList.add('hidden');
      btn.innerText = "End Fast";
      btn.className = "fixed bottom-24 left-1/2 -translate-x-1/2 w-[90%] max-w-md py-4 bg-red-500 hover:bg-red-600 active:scale-95 rounded-2xl text-xl font-bold shadow-2xl z-20 transition-all";
       
      const diff = new Date().getTime() - startTime;
      const totalHours = diff / 3600000;
      const h = Math.floor(totalHours);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      document.getElementById('timer-display').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

      const percent = Math.min((totalHours / goalHours) * 100, 100);
      setProgress(percent);
      if (percent >= 100) {
        label.innerText = "GOAL REACHED! üéâ";
        label.classList.add("text-orange-400");
        document.getElementById('progress-ring').style.stroke = "#22c55e";
      } else {
        label.innerText = `Goal: ${goalHours} Hours`;
        document.getElementById('progress-ring').style.stroke = "#f97316";
      }
      renderPhases(totalHours);
    }

    function renderHistory(history) {
      const container = document.getElementById('history-container');
      const badge = document.getElementById('streak-badge');
      const avgBadge = document.getElementById('avg-badge');

      if (!history || history.length === 0) {
        badge.innerText = "Ready";
        container.classList.add('hidden');
        return;
      }
       
      // 1. Calculate Streak (Keep logic based on Newest->Oldest)
      let currentStreak = 0;
      for (let i = 0; i < history.length; i++) {
          // If the most recent fasts meet the goal, increment streak
          if (parseFloat(history[i].duration) >= (history[i].goal || 0)) currentStreak++;
          else break; 
      }
      badge.innerText = `${currentStreak}üî• Streak`;
      if (currentStreak > 2) badge.classList.replace("text-slate-500", "text-orange-400");
      container.classList.remove('hidden');

      const total = history.reduce((sum, item) => sum + parseFloat(item.duration), 0);
      avgBadge.innerText = `${(total / history.length).toFixed(1)}h Avg`;

      // 2. PREPARE CHART DATA
      // Create a reversed copy so the graph reads Left (Oldest) -> Right (Newest)
      const chartHistory = [...history].reverse(); 

      const labels = chartHistory.map(h => h.date);
      const dataPoints = chartHistory.map(h => h.duration);
      // Only map weight if it exists, otherwise null allows the line to span gaps
      const weights = chartHistory.map(h => (h.weight && Number(h.weight) > 0) ? h.weight : null); 
      const colors = chartHistory.map(h => parseFloat(h.duration) >= (h.goal || 16) ? '#22c55e' : '#f97316');

      if (myChart) myChart.destroy();
      const ctx = document.getElementById('fastChart').getContext('2d');
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { 
                label: 'Weight', 
                data: weights, 
                type: 'line', 
                borderColor: '#38bdf8', 
                yAxisID: 'y1', 
                spanGaps: true,
                tension: 0.4 // Makes the weight line slightly curvy/smooth
            }, 
            { 
                label: 'Hours', 
                data: dataPoints, 
                backgroundColor: colors, 
                borderRadius: 4, 
                yAxisID: 'y' 
            }
          ]
        },
        options: {
          responsive: true, 
          maintainAspectRatio: false, 
          plugins: { legend: { display: false } },
          scales: { 
              y: { display: false }, 
              y1: { 
                  display: true, 
                  position: 'right', 
                  grid: { display: false }, 
                  ticks: { color: '#38bdf8', font: { size: 10 } } 
              }, 
              x: { 
                  grid: { display: false }, 
                  ticks: { color: '#64748b' } 
              } 
          }
        }
      });
    }

    // --- INTERACTION HANDLERS ---
    
    // 1. Log Weight Button
    async function handleLogWeight() {
        const w = await askUser("Log Weight", "Enter current weight:", "lbs / kg");
        if (w) {
            await localApi("logWeight", { weight: w });
            initData(); 
        }
    }

    // 2. Main Toggle (Start / End)
    async function handleToggle() {
      if (!startTime) {
        // STARTING
        const selectedGoal = document.getElementById('goal-input').value;
        const res = await localApi("toggleFast", { goalHours: selectedGoal });
        if (res && res.status === "Started") {
          startTime = res.startTime;
          goalHours = res.goal;
          timerInterval = setInterval(updateUI, 1000);
          updateUI();
        }
      } else {
        // ENDING - Ask for Time Adjustment
        const hoursAgo = await askUser("End Fast", "Finished how many hours ago? (0 for now)", "0");
        if (hoursAgo === null) return; // User cancelled
        
        let customEndTime = null;
        if (parseFloat(hoursAgo) > 0) {
            customEndTime = new Date().getTime() - (parseFloat(hoursAgo) * 60 * 60 * 1000);
        }

        const res = await localApi("toggleFast", { customEndTime: customEndTime });
        
        if (res) {
          if (!customEndTime && (new Date().getTime() - startTime) / 3600000 >= goalHours) {
              confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
          }
          startTime = null;
          clearInterval(timerInterval);
          updateUI();
          initData();
        }
      }
    }

    // 3. Time Travel (Adjust Start)
    async function handleAdjustStart() {
      if (!startTime) {
        // Not running yet: Start in the past
        const hoursAgo = await askUser("Start Time", "Started how many hours ago?", "e.g., 2.5");
        if (!hoursAgo || isNaN(hoursAgo)) return;
        const pastTime = new Date().getTime() - (parseFloat(hoursAgo) * 60 * 60 * 1000);
        const res = await localApi("toggleFast", { goalHours: document.getElementById('goal-input').value, customStartTime: pastTime });
        if (res) { startTime = res.startTime; goalHours = res.goal; timerInterval = setInterval(updateUI, 1000); updateUI(); }
      } else {
        // Already running: Edit current start time
        const hoursAgo = await askUser("Edit Start", "Actually started how many hours ago?", "e.g. 5");
        if (!hoursAgo || isNaN(hoursAgo)) return;
        const pastTime = new Date().getTime() - (parseFloat(hoursAgo) * 60 * 60 * 1000);
        
        const res = await localApi("adjustStart", { customStartTime: pastTime });
        if (res) { startTime = res.startTime; updateUI(); }
      }
    }

    // --- MODAL & UTIL FUNCTIONS ---
    function openModal(i) {
      const p = phases[i];
      document.getElementById('modal-title').innerText = `${p.icon} ${p.title}`;
      document.getElementById('modal-content').innerHTML = p.detail;
      document.getElementById('modal-overlay').classList.remove('hidden');
      document.getElementById('modal').classList.add('open');
    }
     
    function closeModal() {
      document.getElementById('modal-overlay').classList.add('hidden');
      document.getElementById('modal').classList.remove('open');
    }

    function askUser(title, desc, placeholder = "") {
      return new Promise((resolve) => {
        const modal = document.getElementById('input-modal');
        const box = document.getElementById('input-box');
        const input = document.getElementById('input-field');
        document.getElementById('input-title').innerText = title;
        document.getElementById('input-desc').innerText = desc;
        input.placeholder = placeholder;
        input.value = '';
        modal.classList.remove('hidden');
        setTimeout(() => { modal.classList.remove('opacity-0'); box.classList.remove('scale-95'); box.classList.add('scale-100'); input.focus(); }, 10);
        function close(value) { modal.classList.add('opacity-0'); box.classList.remove('scale-100'); box.classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 300); resolve(value); }
        document.getElementById('input-confirm-btn').onclick = () => close(input.value);
        document.getElementById('input-cancel-btn').onclick = () => close(null);
        input.onkeydown = (e) => { if (e.key === "Enter") close(input.value); };
      });
    }

    async function initData(force = false) {
      const res = await localApi("getInitialData", { force: force });
      if (res) {
        if (res.currentFast) {
          startTime = res.currentFast.startTime;
          goalHours = res.currentFast.goal;
          timerInterval = setInterval(updateUI, 1000);
        }
        renderHistory(res.history);
        updateUI();
      }
    }
    window.onload = checkLogin;
	
	
	// Helper: One-way scramble (Hash) the password
async function hashPassword(string) {
  const msgBuffer = new TextEncoder().encode(string);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// EMERGENCY RESET: If stuck on "Authenticating..." for 3 seconds, force logout option
setTimeout(() => {
  const userDisplay = document.getElementById('user-display');
  // If we still see the default text or "Authenticating..."
  if (userDisplay.innerText.includes("Auth") || userDisplay.innerText === "...") {
     console.log("Stuck in login loop. Forcing logout option.");
     userDisplay.innerText = "‚ö†Ô∏è Tap to Reset";
     userDisplay.style.color = "red";
     // Ensure it's clickable even if other things are broken
     userDisplay.onclick = function() {
         if(confirm("Reset App Data?")) {
             localStorage.clear();
             location.reload();
         }
     };
  }
}, 3000);

  </script>
</body>
</html>